# Antiscan - простой инструмент для выявления и блокировки IP с подозрительной активностью.

## Antiscan предназначен для устройств Keenetic/Netcraze, поддерживающих Entware.

### Возможности:
1) Блокировка хостов, открывающих множество соединений с одного IP-адреса.
2) Блокировка хостов, открывающих единичные соединения с множества IP, принадлежащих одной подсети /24.
3) Блокировка хостов по пользовательскому черному/белому списку.
4) Геоблокировка в режиме черного/белого списка.

> [!IMPORTANT]
> Antiscan является IPv4-only. В настоящее время поддержка IPv6 не планируется к реализации.

### Требования для корректной работы скрипта:
1. Установленный компонент "Модули ядра для подсистемы Netfilter" (начиная с версии ПО 4.3 доступен без "Протокол IPv6").
2. Предварительно настроенный и готовый к работе cron. Можно воспользоваться простой и понятной инструкцией: https://web.archive.org/web/20231004003915/https://forums.zyxmon.org/viewtopic.php?f=5&t=5257
3. Установленный пакет wget-ssl в Entware для загрузки Antiscan в режиме "онлайн": `opkg update && opkg install wget-ssl"`

### Установка:
1. **Офлайн вариант:**
	- Скачать пакет и загрузить на устройство/внешний накопитель
	- Выполнить команду `opkg install "/путь_к_пакету/antiscan_1.3.1_all.ipk"`
2. **Онлайн вариант:**
	- Выполнить команду `opkg install https://github.com/dimon27254/antiscan/releases/download/1.3.1/antiscan_1.3.1_all.ipk"`
3. Указать unix-имена интерфейсов интернет-подключений в файле `"/opt/etc/ascn.conf"`. В ПО версии 4.3 и выше просмотр unix-имен интерфейсов доступен по команде `show interface {интерфейс} system-name`
4. Настроить чтение и хранение списков адресов, если это требуется, в файле `"/opt/etc/ascn.conf"`
5. Запустить Antiscan командой `antiscan start`

### Описание параметров в ascn.conf:
```
# Общие настройки:
# Перечень интерфейсов, на которых работает Antiscan. Множество интерфейсов указывается через пробел, пример: "eth3 eth2.2 ppp0":
ISP_INTERFACES="eth3" 

# Перечень портов, на которых работает Antiscan. Множество портов указывается через запятую, пример: "22,80,443":
PORTS="22,80,443"

# Настройки ограничения множественных соединений:
# ДЛЯ ОПЫТНЫХ ПОЛЬЗОВАТЕЛЕЙ! Маска правил iptables для отслеживания соединений:
RULES_MASK="255.255.255.255"

# Время наблюдения за новыми соединениями от IP в секундах:
RECENT_CONNECTIONS_TIME=30 

# Пороговое значение новых соединений за период RECENT_CONNECTIONS_TIME, после которого IP будет заблокирован:
RECENT_CONNECTIONS_HITCOUNT=15    

# Общий лимит множественных соединений с одного адреса, после которого он будет заблокирован:
RECENT_CONNECTIONS_LIMIT=20 

# Длительность блокировки IP в секундах:     
RECENT_CONNECTIONS_BANTIME=864000   

# Настройки ограничения соединений с разных IP:
# Срок хранения IP-адресов-кандидатов на блокировку:
DIFFERENT_IP_CANDIDATES_STORAGETIME=864000

# Пороговое значение IP-кандидатов, начиная с которого будет создана подсеть для блокировки:
DIFFERENT_IP_THRESHOLD=5

# Длительность блокировки подсети в секундах:
SUBNETS_BANTIME=864000

# Путь к каталогу, внутри которого будут находиться все списки адресов. Пример: "/tmp/mnt/MYDISK/antiscan"
IPSETS_DIRECTORY=""

# Сохранять списки заблокированных IP и подсетей в файлы. 0 - выключено, 1 - включено
SAVE_IPSETS=0

# Использовать пользовательский список адресов-исключений. 0 - выключено, 1 - включено
USE_CUSTOM_EXCLUDE_LIST=0

# Режим блокировки по пользовательским спискам. 0 - отключена, blacklist - черный список, whitelist - белый список
CUSTOM_LISTS_BLOCK_MODE=0

# Режим геоблокировки. 0 - отключена, blacklist - черный список, whitelist - белый список
GEOBLOCK_MODE=0

# Перечень стран для геоблокировки. Пример: одна страна - "US", множество стран - "RU DE"
GEOBLOCK_COUNTRIES=""
```
> [!TIP]
> Период чтения списка кандидатов по умолчанию равен 1 минуте.
> 
> Текст задачи в cron: `*/1 * * * * /opt/etc/init.d/S99ascn read_candidates &`
>
> Списки адресов по умолчанию сохраняются каждые 5 дней в 00:00.
>
> Текст задачи в cron: `0 0 */5 * * /opt/etc/init.d/S99ascn save_ipsets &`
>
> Списки подсетей для геоблокировки по умолчанию обновляются каждые 15 дней в 00:05.
>
> Текст задачи в cron: `0 5 */15 * * /opt/etc/init.d/S99ascn update_ipsets geo &`

### Использование S99ascn:
```
{start|stop|restart|status|list|reload|flush|update_rules|read_candidates|save_ipsets|update_ipsets}
start                            начать работу скрипта (создать правила, ipset'ы, начать сбор IP)
stop                             остановить работу скрипта (удалить правила, очистить ipset'ы, отменить блокировку)
restart                          остановить и заново начать работу скрипта
status                           отобразить статус Antiscan и количество заблокированных IP, подсетей
list {ips|subnets}               отобразить список и количество заблокированных IP/подсетей
reload                           обновить конфигурацию Antiscan (перечитать файл ascn.conf)

flush [candidates|ips|subnets|custom_whitelist|custom_blacklist|custom_exclude|geo]
                                 очистить списки адресов и удалить их файлы

update_rules                     проверить наличие правил iptables, и добавить их при отсутствии (для hook-скрипта netfilter.d)
read_candidates                  обработать список адресов кандидатов для блокировки по подсетям (запускается вручную или по расписанию)
save_ipsets                      сохранить списки накопленных адресов в файлы (запускается вручную или по расписанию)
update_ipsets {custom|geo}       обновить пользовательские списки адресов или подсети для геоблокировки (запускается вручную или по расписанию)
```
